<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>櫃體置物管理應用程式</title>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#3B82F6', // 藍色
                        secondary: '#6B7280', // 灰色
                        accent: '#F59E0B' // 橘色提醒
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen p-4 font-sans">
    <!-- 搜尋與篩選區 -->
    <div id="searchBar" class="mb-4 flex flex-col sm:flex-row gap-2">
        <input id="searchName" type="text" placeholder="搜尋物品名稱..." class="flex-1 p-2 border rounded-lg">
        <input id="searchDate" type="date" class="p-2 border rounded-lg">
        <button id="searchBtn" class="px-4 py-2 bg-primary text-white rounded-lg">搜尋</button>
        <button id="exportBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg">匯出資料</button>
        <button id="importBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg">匯入資料</button>
        <input id="importInput" type="file" accept=".json" class="hidden">
    </div>

    <!-- 地點分類頁面 -->
    <div id="locationsPage" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-4"></div>
    <button id="addLocationBtn" class="px-4 py-2 bg-primary text-white rounded-lg mb-4">新增地點</button>

    <!-- 區域分類頁面 -->
    <div id="areasPage" class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-4">
        <button class="backToLocations mb-4 px-4 py-2 bg-secondary text-white rounded-lg">返回地點</button>
    </div>
    <button id="addAreaBtn" class="hidden px-4 py-2 bg-primary text-white rounded-lg mb-4">新增區域</button>

    <!-- 櫃體頁面 -->
    <div id="cabinetsPage" class="hidden">
        <div class="flex gap-2 mb-4">
            <button class="backToLocations px-4 py-2 bg-secondary text-white rounded-lg">返回地點</button>
            <button class="backToAreas px-4 py-2 bg-secondary text-white rounded-lg">返回區域</button>
        </div>
        <h2 id="currentArea" class="text-xl font-semibold mb-4"></h2>
        <div id="cabinetsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-4"></div>
        <button id="addCabinetBtn" class="px-4 py-2 bg-primary text-white rounded-lg">新增櫃體</button>
    </div>

    <!-- 儲存格頁面 -->
    <div id="cellsPage" class="hidden">
        <div class="flex gap-2 mb-4">
            <button class="backToLocations px-4 py-2 bg-secondary text-white rounded-lg">返回地點</button>
            <button class="backToCabinets px-4 py-2 bg-secondary text-white rounded-lg">返回櫃體</button>
        </div>
        <h3 id="currentCabinet" class="text-lg font-semibold mb-4"></h3>
        <div id="cellsGrid" class="grid gap-1 mb-4"></div>
        <div class="flex gap-2">
            <button id="editGridBtn" class="px-4 py-2 bg-accent text-white rounded-lg">編輯網格</button>
            <button id="undoMergeBtn" class="px-4 py-2 bg-secondary text-white rounded-lg hidden">復原合併</button>
            <button id="splitCellBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hidden">分拆網格</button>
        </div>
    </div>

    <!-- 物品詳情模態 -->
    <div id="itemModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-11/12 max-w-lg max-h-[80vh] overflow-y-auto">
            <h4 id="modalTitle" class="text-lg font-semibold mb-4"></h4>
            <table id="itemsTable" class="w-full mb-4 border-collapse">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="p-2">圖片</th>
                        <th class="p-2 cursor-pointer" data-sort="name">名稱</th>
                        <th class="p-2 cursor-pointer" data-sort="quantity">數量</th>
                        <th class="p-2 cursor-pointer" data-sort="entryDate">存入日期</th>
                        <th class="p-2 cursor-pointer" data-sort="expiryDate">有效日期</th>
                        <th class="p-2 cursor-pointer" data-sort="purchasePlace">購買地</th>
                        <th class="p-2">備註</th>
                        <th class="p-2">操作</th>
                    </tr>
                </thead>
                <tbody id="itemsList"></tbody>
            </table>
            <form id="itemForm" class="space-y-2">
                <input id="itemName" type="text" placeholder="物品名稱 (必填)" class="w-full p-2 border rounded" required>
                <input id="itemQty" type="number" placeholder="數量" class="w-full p-2 border rounded">
                <input id="itemInDate" type="date" placeholder="存入日期" class="w-full p-2 border rounded">
                <input id="itemExpDate" type="date" placeholder="有效日期" class="w-full p-2 border rounded">
                <input id="itemPlace" type="text" placeholder="購買地" class="w-full p-2 border rounded">
                <textarea id="itemNote" placeholder="備註" class="w-full p-2 border rounded"></textarea>
                <input id="itemImage" type="file" accept="image/*" class="w-full p-2 border rounded">
                <button type="submit" id="itemFormSubmit" class="px-4 py-2 bg-primary text-white rounded">新增物品</button>
            </form>
            <button id="closeModal" class="mt-4 px-4 py-2 bg-secondary text-white rounded float-right">關閉</button>
        </div>
    </div>

    <!-- 圖片預覽模態 -->
    <div id="imagePreviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-11/12 max-w-lg">
            <img id="previewImage" class="modal-image mx-auto" src="" alt="物品圖片">
            <button id="closeImagePreview" class="mt-4 px-4 py-2 bg-secondary text-white rounded">關閉</button>
        </div>
    </div>

    <!-- 新增/編輯地點/區域/櫃體模態 -->
    <div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-11/12 max-w-md">
            <h4 id="addTitle" class="text-lg font-semibold mb-4"></h4>
            <input id="addInput" type="text" placeholder="名稱" class="w-full p-2 border rounded mb-2">
            <select id="cabinetType" class="w-full p-2 border rounded mb-2 hidden">
                <option value="L">L-型</option>
                <option value="straight">一字形</option>
                <option value="U">U-型</option>
                <option value="square">口-型</option>
            </select>
            <div id="dimensionsInputs" class="space-y-2"></div>
            <div class="flex gap-2 mt-4">
                <button id="saveAdd" class="px-4 py-2 bg-primary text-white rounded">儲存</button>
                <button id="deleteAdd" class="px-4 py-2 bg-red-500 text-white rounded hidden">刪除</button>
                <button id="cancelAdd" class="px-4 py-2 bg-secondary text-white rounded">取消</button>
            </div>
        </div>
    </div>

    <!-- 到期提醒模態 -->
    <div id="reminderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-11/12 max-w-md">
            <h4 class="text-lg font-semibold mb-4">到期提醒</h4>
            <div id="reminderList" class="mb-4"></div>
            <button id="closeReminder" class="px-4 py-2 bg-primary text-white rounded">確認</button>
        </div>
    </div>

    <style>
        .grid-cell {
            border: 1px solid #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            text-align: center;
            min-height: 50px;
        }
        .merged { background-color: #f3f4f6; }
        .selected { background-color: #bfdbfe !important; }
        .scroll-container {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            padding: 2px;
            width: 100%;
            font-size: 0.75rem;
            scrollbar-width: thin;
            scrollbar-color: #6B7280 #e5e7eb;
        }
        .scroll-container::-webkit-scrollbar {
            height: 6px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background: #6B7280;
            border-radius: 3px;
        }
        .scroll-item {
            display: inline-block;
            margin-right: 8px;
        }
        .item-image {
            max-width: 50px;
            max-height: 50px;
            object-fit: cover;
            cursor: pointer;
        }
        .modal-image {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
        }
    </style>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';

        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyDxJCKSvrB3a6tYtzV9Q90p68odxaqQcXw",
            authDomain: "cabinet-sync-db.firebaseapp.com",
            databaseURL: "https://cabinet-sync-db-default-rtdb.firebaseio.com",
            projectId: "cabinet-sync-db",
            storageBucket: "cabinet-sync-db.firebasestorage.app",
            messagingSenderId: "209194186803",
            appId: "1:209194186803:web:6498fd5c812ea419e5cb46"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // 預設地點與區域
        const defaultLocations = [
            { 
                name: '家裡', 
                areas: ['客廳', '廚房', '玄關', '浴室', '樓下房間', '書房', '樓上小孩房', '主臥室'] 
            },
            { name: '辦公室', areas: [] }
        ];

        // 全域資料
        let data = {};
        let currentLocationId = null;
        let currentAreaId = null;
        let currentCabinetId = null;
        let currentCellId = null;
        let editMode = false;
        let selectedCells = [];
        let editingCabinet = false;
        let editingCabinetId = null;
        let mergeHistory = [];
        let addModalType = '';
        let editingItemIndex = -1;

        // 載入資料（從 Firebase）
        async function loadData() {
            try {
                const snapshot = await get(ref(db, '/cabinetData'));
                data = snapshot.val() || {
                    locations: defaultLocations.reduce((acc, loc) => {
                        const locId = loc.name.toLowerCase().replace(/\s/g, '-');
                        acc[locId] = {
                            name: loc.name,
                            areas: loc.areas.reduce((areaAcc, areaName) => {
                                const areaId = areaName.toLowerCase().replace(/\s/g, '-');
                                areaAcc[areaId] = { name: areaName, cabinets: {} };
                                return areaAcc;
                            }, {})
                        };
                        return acc;
                    }, {})
                };
                // 確保每個地點都有 areas 屬性，並驗證 cabinets
                Object.keys(data.locations).forEach(locId => {
                    if (!data.locations[locId].areas) {
                        data.locations[locId].areas = {};
                    }
                    Object.keys(data.locations[locId].areas).forEach(areaId => {
                        if (!data.locations[locId].areas[areaId].cabinets) {
                            data.locations[locId].areas[areaId].cabinets = {};
                        }
                    });
                    if (locId === '家裡' && Object.keys(data.locations[locId].areas).length === 0) {
                        data.locations[locId].areas = defaultLocations[0].areas.reduce((areaAcc, areaName) => {
                            const areaId = areaName.toLowerCase().replace(/\s/g, '-');
                            areaAcc[areaId] = { name: areaName, cabinets: {} };
                            return areaAcc;
                        }, {});
                    }
                });
                if (!snapshot.val()) {
                    await set(ref(db, '/cabinetData'), data);
                    console.log('已將預設資料寫入 Firebase');
                }
                console.log('載入資料成功:', data);
            } catch (error) {
                console.error('載入資料失敗:', error);
                data = {
                    locations: defaultLocations.reduce((acc, loc) => {
                        const locId = loc.name.toLowerCase().replace(/\s/g, '-');
                        acc[locId] = {
                            name: loc.name,
                            areas: loc.areas.reduce((areaAcc, areaName) => {
                                const areaId = areaName.toLowerCase().replace(/\s/g, '-');
                                areaAcc[areaId] = { name: areaName, cabinets: {} };
                                return areaAcc;
                            }, {})
                        };
                        return acc;
                    }, {})
                };
                await set(ref(db, '/cabinetData'), data);
                console.log('已初始化預設資料:', data);
            }
        }

        // 儲存資料（到 Firebase）
        async function saveData() {
            try {
                await set(ref(db, '/cabinetData'), data);
                console.log('資料儲存成功');
            } catch (error) {
                console.error('儲存失敗:', error);
                alert('儲存資料時發生錯誤，請檢查網路連線或稍後再試！');
            }
        }

        // 即時同步
        onValue(ref(db, '/cabinetData'), (snapshot) => {
            try {
                const updatedData = snapshot.val();
                if (updatedData && JSON.stringify(updatedData) !== JSON.stringify(data)) {
                    data = updatedData;
                    console.log('資料已同步:', data);
                    Object.keys(data.locations).forEach(locId => {
                        if (!data.locations[locId].areas) {
                            data.locations[locId].areas = {};
                        }
                        Object.keys(data.locations[locId].areas).forEach(areaId => {
                            if (!data.locations[locId].areas[areaId].cabinets) {
                                data.locations[locId].areas[areaId].cabinets = {};
                            }
                        });
                    });
                    if (currentCabinetId) renderCells();
                    else if (currentAreaId) renderCabinets();
                    else if (currentLocationId) renderAreasPage();
                    else renderLocationsPage();
                }
            } catch (error) {
                console.error('同步資料失敗:', error);
                alert('資料同步失敗，請檢查網路連線或重新整理頁面！');
            }
        });

        function renderLocationsPage() {
            document.getElementById('locationsPage').classList.remove('hidden');
            document.getElementById('areasPage').classList.add('hidden');
            document.getElementById('cabinetsPage').classList.add('hidden');
            document.getElementById('cellsPage').classList.add('hidden');
            document.getElementById('addAreaBtn').classList.add('hidden');
            const container = document.getElementById('locationsPage');
            container.innerHTML = Object.entries(data.locations).map(([id, loc]) => `
                <div class="bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg location-card" data-loc-id="${id}">
                    <h3 class="text-lg font-medium">${loc.name}</h3>
                    <button class="edit-location float-right text-secondary hover:text-primary" data-loc-id="${id}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                        </svg>
                    </button>
                </div>
            `).join('') || '<p class="text-gray-500">目前無地點，請點擊「新增地點」按鈕</p>';
        }

        function enterLocation(locId) {
            currentLocationId = locId;
            renderAreasPage();
        }

        function editLocation(locId, event) {
            event.stopPropagation();
            addModalType = 'location';
            const loc = data.locations[locId];
            document.getElementById('addTitle').textContent = '編輯地點';
            document.getElementById('addInput').value = loc.name;
            document.getElementById('addInput').dataset.oldId = locId;
            document.getElementById('cabinetType').classList.add('hidden');
            document.getElementById('dimensionsInputs').innerHTML = '';
            document.getElementById('deleteAdd').classList.remove('hidden');
            document.getElementById('addModal').classList.remove('hidden');
        }

        function renderAreasPage() {
            document.getElementById('locationsPage').classList.add('hidden');
            document.getElementById('areasPage').classList.remove('hidden');
            document.getElementById('cabinetsPage').classList.add('hidden');
            document.getElementById('cellsPage').classList.add('hidden');
            document.getElementById('addAreaBtn').classList.remove('hidden');
            document.getElementById('currentArea').textContent = '';
            const container = document.getElementById('areasPage');
            const areas = data.locations[currentLocationId]?.areas || {};
            container.innerHTML = `
                <button class="backToLocations mb-4 px-4 py-2 bg-secondary text-white rounded-lg">返回地點</button>
                ${Object.keys(areas).length === 0 ? 
                    '<p class="text-gray-500">目前無區域，請點擊「新增區域」按鈕</p>' :
                    Object.entries(areas).map(([id, area]) => `
                        <div class="bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg area-card" data-area-id="${id}">
                            <h3 class="text-lg font-medium">${area.name}</h3>
                            <button class="edit-area float-right text-secondary hover:text-primary" data-area-id="${id}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                </svg>
                            </button>
                        </div>
                    `).join('')}
            `;
        }

        function enterArea(areaId) {
            currentAreaId = areaId;
            document.getElementById('areasPage').classList.add('hidden');
            document.getElementById('cabinetsPage').classList.remove('hidden');
            document.getElementById('currentArea').textContent = data.locations[currentLocationId].areas[areaId]?.name || '未知區域';
            renderCabinets();
        }

        function renderCabinets() {
            const cabinets = data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets || {};
            const container = document.getElementById('cabinetsGrid');
            container.innerHTML = Object.keys(cabinets).length === 0 ?
                '<p class="text-gray-500">目前無櫃體，請點擊「新增櫃體」按鈕</p>' :
                Object.entries(cabinets).map(([id, cab]) => `
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-medium">${cab.name}</h3>
                        <p class="text-sm text-secondary">類型: ${cab.type}</p>
                        <button class="view-cabinet mt-2 px-3 py-1 bg-primary text-white rounded" data-cab-id="${id}">查看</button>
                        <button class="edit-cabinet mt-2 px-3 py-1 bg-accent text-white rounded ml-2" data-cab-id="${id}">編輯</button>
                        <button class="delete-cabinet mt-2 px-3 py-1 bg-red-500 text-white rounded ml-2" data-cab-id="${id}">刪除</button>
                    </div>
                `).join('');
        }

        function editCabinet(cabId, event) {
            event.stopPropagation();
            addModalType = 'cabinet';
            editingCabinet = true;
            editingCabinetId = cabId;
            const cab = data.locations[currentLocationId].areas[currentAreaId].cabinets[cabId];
            document.getElementById('addTitle').textContent = '編輯櫃體';
            document.getElementById('addInput').value = cab.name;
            document.getElementById('addInput').dataset.oldId = cabId;
            document.getElementById('cabinetType').classList.remove('hidden');
            document.getElementById('cabinetType').value = cab.type;
            document.getElementById('deleteAdd').classList.remove('hidden');
            updateDimensionsInputs(cab.dimensions);
            document.getElementById('addModal').classList.remove('hidden');
        }

        function validateDimension(dim) {
            return /^[0-9]+x[0-9]+$/.test(dim.toLowerCase());
        }

        function updateDimensionsInputs(dimensions = {}) {
            const type = document.getElementById('cabinetType').value;
            const inputs = document.getElementById('dimensionsInputs');
            inputs.innerHTML = '';
            if (type === 'L') {
                inputs.innerHTML = `
                    <input type="text" placeholder="短L規格 (e.g., 3x3 or 3X3)" class="w-full p-2 border rounded mb-2" value="${dimensions.short || ''}">
                    <input type="text" placeholder="長L規格 (e.g., 4x3 or 4X3)" class="w-full p-2 border rounded" value="${dimensions.long || ''}">
                `;
            } else if (type === 'straight') {
                inputs.innerHTML = `<input type="text" placeholder="規格 (e.g., 3x3 or 3X3)" class="w-full p-2 border rounded" value="${dimensions.size || ''}">`;
            } else if (type === 'U' || type === 'square') {
                const sides = type === 'U' ? 3 : 4;
                for (let i = 1; i <= sides; i++) {
                    inputs.innerHTML += `<input type="text" placeholder="面${i}規格 (e.g., 3x3 or 3X3)" class="w-full p-2 border rounded mb-2" value="${dimensions[`side${i}`] || ''}">`;
                }
            }
        }

        async function deleteCabinet(cabId, event) {
            event.stopPropagation();
            if (confirm('確定要刪除這個櫃體嗎？')) {
                delete data.locations[currentLocationId].areas[currentAreaId].cabinets[cabId];
                await saveData();
                renderCabinets();
            }
        }

        function enterCabinet(cabId) {
            currentCabinetId = cabId;
            document.getElementById('cabinetsPage').classList.add('hidden');
            document.getElementById('cellsPage').classList.remove('hidden');
            document.getElementById('currentCabinet').textContent = data.locations[currentLocationId].areas[currentAreaId].cabinets[cabId]?.name || '未知櫃體';
            mergeHistory = [];
            renderCells();
            updateButtonVisibility();
        }

        function updateButtonVisibility() {
            const undoBtn = document.getElementById('undoMergeBtn');
            const splitBtn = document.getElementById('splitCellBtn');
            undoBtn.classList.toggle('hidden', mergeHistory.length === 0);
            splitBtn.classList.toggle('hidden', !editMode);
        }

        function renderCells() {
            const cab = data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[currentCabinetId];
            if (!cab) {
                document.getElementById('cellsGrid').innerHTML = '<p class="text-gray-500">櫃體資料缺失</p>';
                return;
            }
            let sizeStr = cab.dimensions?.size ? cab.dimensions.size.toLowerCase() : '3x3';
            const dimensions = sizeStr.split('x');
            const rows = parseInt(dimensions[0]) || 3;
            const cols = parseInt(dimensions[1]) || 3;
            const container = document.getElementById('cellsGrid');
            container.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
            container.innerHTML = '';
            const renderedCells = new Set();

            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    const cellId = `${i}-${j}`;
                    if (renderedCells.has(cellId)) continue;
                    const cellData = cab.cells_data?.[cellId] || { items: [], merged: false, span: { row: 1, col: 1 }, text: '' };
                    const items = cellData.items || [];
                    const bgColor = items.some(item => isExpiringSoon(item.expiryDate)) ? 'bg-accent' : 'bg-gray-100';
                    const cell = document.createElement('div');
                    cell.className = `grid-cell p-2 ${bgColor} rounded text-xs ${cellData.merged ? 'merged' : ''} ${selectedCells.includes(cellId) ? 'selected' : ''}`;
                    const scrollContainer = document.createElement('div');
                    scrollContainer.className = 'scroll-container';
                    scrollContainer.textContent = cellData.text || (items.length === 0 ? '空' : items.map(item => item.name).join(', '));
                    cell.appendChild(scrollContainer);
                    if (cellData.merged) {
                        cell.style.gridRow = `span ${cellData.span.row}`;
                        cell.style.gridColumn = `span ${cellData.span.col}`;
                        for (let ri = i; ri < i + cellData.span.row; ri++) {
                            for (let cj = j; cj < j + cellData.span.col; cj++) {
                                renderedCells.add(`${ri}-${cj}`);
                            }
                        }
                    } else {
                        renderedCells.add(cellId);
                    }
                    cell.onclick = () => editMode ? selectCell(cellId, cell) : openItemModal(cellId);
                    container.appendChild(cell);
                }
            }
            updateButtonVisibility();
        }

        function selectCell(cellId, element) {
            const cab = data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[currentCabinetId];
            if (!cab) return;
            const cellData = cab.cells_data?.[cellId] || { merged: false };
            if (editMode && cellData.merged) {
                selectedCells = [cellId];
                document.querySelectorAll('.grid-cell').forEach(cell => cell.classList.remove('selected'));
                element.classList.add('selected');
            } else if (editMode) {
                if (selectedCells.includes(cellId)) {
                    selectedCells = selectedCells.filter(id => id !== cellId);
                    element.classList.remove('selected');
                } else {
                    selectedCells.push(cellId);
                    element.classList.add('selected');
                }
            }
            renderCells();
        }

        async function mergeCells() {
            if (selectedCells.length < 2) {
                alert('請選取至少2個相鄰格子！');
                return;
            }
            const cab = data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[currentCabinetId];
            if (!cab) {
                alert('櫃體資料缺失，請返回重新選擇');
                return;
            }
            if (!cab.cells_data) cab.cells_data = {};
            const positions = selectedCells.map(id => id.split('-').map(Number));
            const minRow = Math.min(...positions.map(p => p[0]));
            const maxRow = Math.max(...positions.map(p => p[0]));
            const minCol = Math.min(...positions.map(p => p[1]));
            const maxCol = Math.max(...positions.map(p => p[1]));
            const rowSpan = maxRow - minRow + 1;
            const colSpan = maxCol - minCol + 1;
            const expectedCount = rowSpan * colSpan;
            if (selectedCells.length !== expectedCount) {
                alert('請選取完整相鄰矩形！');
                return;
            }
            const requiredCells = [];
            for (let i = minRow; i <= maxRow; i++) {
                for (let j = minCol; j <= maxCol; j++) {
                    requiredCells.push(`${i}-${j}`);
                }
            }
            if (!requiredCells.every(cell => selectedCells.includes(cell))) {
                alert('選取的格子必須相鄰且形成矩形！');
                return;
            }
            const cells = cab.cells_data;
            const mergedId = selectedCells[0];
            let mergedItems = [];
            let mergedText = '';
            const historyEntry = { mergedId, cells: {} };
            selectedCells.forEach(id => {
                if (cells[id]) {
                    historyEntry.cells[id] = { ...cells[id] };
                    mergedItems = [...mergedItems, ...(cells[id].items || [])];
                    if (cells[id].text) mergedText += (mergedText ? ', ' : '') + cells[id].text;
                }
            });
            mergeHistory.push(historyEntry);
            selectedCells.forEach(id => {
                if (id !== mergedId) delete cells[id];
            });
            cells[mergedId] = {
                items: mergedItems,
                merged: true,
                span: { row: rowSpan, col: colSpan },
                text: mergedText
            };
            await saveData();
            selectedCells = [];
            editMode = false;
            document.getElementById('editGridBtn').textContent = '編輯網格';
            renderCells();
        }

        async function undoMerge() {
            if (mergeHistory.length === 0) return;
            const lastMerge = mergeHistory.pop();
            const cab = data.locations[currentLocationId].areas[currentAreaId].cabinets[currentCabinetId];
            const cells = cab.cells_data || {};
            Object.entries(lastMerge.cells).forEach(([id, cellData]) => {
                cells[id] = { ...cellData };
            });
            delete cells[lastMerge.mergedId];
            await saveData();
            selectedCells = [];
            editMode = false;
            document.getElementById('editGridBtn').textContent = '編輯網格';
            renderCells();
        }

        async function splitCell() {
            if (selectedCells.length !== 1) {
                alert('請選取一個已合併的格子進行分拆！');
                return;
            }
            const cellId = selectedCells[0];
            const cab = data.locations[currentLocationId].areas[currentAreaId].cabinets[currentCabinetId];
            const cells = cab.cells_data || {};
            const cellData = cells[cellId];
            if (!cellData || !cellData.merged) {
                alert('選取的格子未合併！');
                return;
            }
            const [row, col] = cellId.split('-').map(Number);
            const { row: rowSpan, col: colSpan } = cellData.span;
            const historyEntry = { mergedId: cellId, cells: { [cellId]: { ...cellData } } };
            mergeHistory.push(historyEntry);
            for (let i = row; i < row + rowSpan; i++) {
                for (let j = col; j < col + colSpan; j++) {
                    const newCellId = `${i}-${j}`;
                    cells[newCellId] = {
                        items: i === row && j === col ? cellData.items : [],
                        merged: false,
                        span: { row: 1, col: 1 },
                        text: i === row && j === col ? cellData.text : ''
                    };
                }
            }
            delete cells[cellId];
            await saveData();
            selectedCells = [];
            editMode = false;
            document.getElementById('editGridBtn').textContent = '編輯網格';
            renderCells();
        }

        function openItemModal(cellId) {
            currentCellId = cellId;
            const cab = data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[currentCabinetId];
            if (!cab) {
                alert('櫃體資料缺失，請返回重新選擇');
                return;
            }
            const cells = cab.cells_data || {};
            const cellData = cells[cellId] || { items: [], merged: false, span: { row: 1, col: 1 }, text: '' };
            const items = cellData.items || [];
            document.getElementById('modalTitle').textContent = `儲存格 ${cellId}`;
            const list = document.getElementById('itemsList');
            list.innerHTML = items.map((item, idx) => `
                <tr class="border-b">
                    <td class="p-2">
                        ${item.image ? `<img src="${item.image}" class="item-image" data-image="${encodeURIComponent(item.image)}">` : '無圖片'}
                    </td>
                    <td class="p-2">${item.name}</td>
                    <td class="p-2">${item.quantity || ''}</td>
                    <td class="p-2">${item.entryDate || ''}</td>
                    <td class="p-2">${item.expiryDate || ''}</td>
                    <td class="p-2">${item.purchasePlace || ''}</td>
                    <td class="p-2">${item.notes || ''}</td>
                    <td class="p-2 flex flex-wrap gap-1">
                        <button class="edit-item text-blue-500 hover:underline" data-index="${idx}">編輯</button>
                        ${item.image ? `<button class="remove-image text-blue-500 hover:underline" data-index="${idx}">刪除圖片</button>` : ''}
                        <button class="delete-item text-red-500 hover:underline" data-index="${idx}">刪除</button>
                        <button class="move-up text-green-500 hover:underline ${idx === 0 ? 'opacity-50 cursor-not-allowed' : ''}" data-index="${idx}" ${idx === 0 ? 'disabled' : ''}>上移</button>
                        <button class="move-down text-green-500 hover:underline ${idx === items.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" data-index="${idx}" ${idx === items.length - 1 ? 'disabled' : ''}>下移</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('itemForm').reset();
            document.getElementById('itemName').value = cellData.text || '';
            document.getElementById('itemFormSubmit').textContent = '新增物品';
            editingItemIndex = -1;
            document.getElementById('itemModal').classList.remove('hidden');
        }

        function editItem(index) {
            console.log('編輯物品，索引:', index);
            const cab = data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[currentCabinetId];
            if (!cab || !cab.cells_data?.[currentCellId]) {
                alert('儲存格資料缺失，請重新選擇！');
                return;
            }
            const item = cab.cells_data[currentCellId].items[index];
            if (!item) {
                alert('物品資料不存在！');
                return;
            }
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemQty').value = item.quantity || '';
            document.getElementById('itemInDate').value = item.entryDate || '';
            document.getElementById('itemExpDate').value = item.expiryDate || '';
            document.getElementById('itemPlace').value = item.purchasePlace || '';
            document.getElementById('itemNote').value = item.notes || '';
            document.getElementById('itemFormSubmit').textContent = '更新物品';
            editingItemIndex = index;
            document.getElementById('itemModal').classList.remove('hidden');
        }

        async function removeImage(index) {
            console.log('刪除照片，索引:', index);
            if (confirm('確定要刪除這張照片嗎？物品其他資訊將保留。')) {
                const cab = data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[currentCabinetId];
                if (!cab || !cab.cells_data?.[currentCellId]) {
                    alert('儲存格資料缺失，請重新選擇！');
                    return;
                }
                const item = cab.cells_data[currentCellId].items[index];
                if (!item) {
                    alert('物品資料不存在！');
                    return;
                }
                item.image = '';
                await saveData();
                openItemModal(currentCellId);
            }
        }

        async function deleteItem(index) {
            console.log('刪除物品，索引:', index);
            if (confirm('確定要刪除這個物品嗎？')) {
                const cab = data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[currentCabinetId];
                if (!cab || !cab.cells_data?.[currentCellId]) {
                    alert('儲存格資料缺失，請重新選擇！');
                    return;
                }
                cab.cells_data[currentCellId].items.splice(index, 1);
                if (cab.cells_data[currentCellId].items.length === 0) {
                    cab.cells_data[currentCellId].text = '';
                } else {
                    cab.cells_data[currentCellId].text = cab.cells_data[currentCellId].items.map(item => item.name).join(', ');
                }
                if (cab.cells_data[currentCellId].items.length === 0) {
                    delete cab.cells_data[currentCellId];
                }
                await saveData();
                openItemModal(currentCellId);
            }
        }

        async function moveItemUp(index) {
            console.log('上移物品，索引:', index);
            const cab = data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[currentCabinetId];
            if (!cab || !cab.cells_data?.[currentCellId]) {
                alert('儲存格資料缺失，請重新選擇！');
                return;
            }
            const items = cab.cells_data[currentCellId].items;
            if (index <= 0 || index >= items.length) {
                alert('無法上移，物品已在頂部或索引無效！');
                return;
            }
            [items[index], items[index - 1]] = [items[index - 1], items[index]];
            cab.cells_data[currentCellId].text = items.map(item => item.name).join(', ');
            await saveData();
            openItemModal(currentCellId);
        }

        async function moveItemDown(index) {
            console.log('下移物品，索引:', index);
            const cab = data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[currentCabinetId];
            if (!cab || !cab.cells_data?.[currentCellId]) {
                alert('儲存格資料缺失，請重新選擇！');
                return;
            }
            const items = cab.cells_data[currentCellId].items;
            if (index < 0 || index >= items.length - 1) {
                alert('無法下移，物品已在底部或索引無效！');
                return;
            }
            [items[index], items[index + 1]] = [items[index + 1], items[index]];
            cab.cells_data[currentCellId].text = items.map(item => item.name).join(', ');
            await saveData();
            openItemModal(currentCellId);
        }

        async function sortItems(field) {
            const cab = data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[currentCabinetId];
            if (!cab || !cab.cells_data[currentCellId]) return;
            const items = cab.cells_data[currentCellId].items || [];
            items.sort((a, b) => {
                let valA = a[field] || '';
                let valB = b[field] || '';
                if (field.includes('Date')) {
                    valA = new Date(valA).getTime() || 0;
                    valB = new Date(valB).getTime() || 0;
                } else if (field === 'quantity') {
                    valA = parseInt(valA) || 0;
                    valB = parseInt(valB) || 0;
                }
                return valA > valB ? 1 : -1;
            });
            cab.cells_data[currentCellId].text = items.map(item => item.name).join(', ');
            await saveData();
            openItemModal(currentCellId);
        }

        document.getElementById('addLocationBtn').addEventListener('click', () => {
            addModalType = 'location';
            document.getElementById('addTitle').textContent = '新增地點';
            document.getElementById('addInput').value = '';
            document.getElementById('addInput').dataset.oldId = '';
            document.getElementById('cabinetType').classList.add('hidden');
            document.getElementById('dimensionsInputs').innerHTML = '';
            document.getElementById('deleteAdd').classList.add('hidden');
            document.getElementById('addModal').classList.remove('hidden');
        });

        document.getElementById('addAreaBtn').addEventListener('click', () => {
            addModalType = 'area';
            document.getElementById('addTitle').textContent = '新增區域';
            document.getElementById('addInput').value = '';
            document.getElementById('addInput').dataset.oldId = '';
            document.getElementById('cabinetType').classList.add('hidden');
            document.getElementById('dimensionsInputs').innerHTML = '';
            document.getElementById('deleteAdd').classList.add('hidden');
            document.getElementById('addModal').classList.remove('hidden');
        });

        function editArea(areaId, event) {
            event.stopPropagation();
            addModalType = 'area';
            const area = data.locations[currentLocationId]?.areas[areaId];
            if (!area) return;
            document.getElementById('addTitle').textContent = '編輯區域';
            document.getElementById('addInput').value = area.name;
            document.getElementById('addInput').dataset.oldId = areaId;
            document.getElementById('cabinetType').classList.add('hidden');
            document.getElementById('dimensionsInputs').innerHTML = '';
            document.getElementById('deleteAdd').classList.remove('hidden');
            document.getElementById('addModal').classList.remove('hidden');
        }

        document.getElementById('addCabinetBtn').addEventListener('click', () => {
            addModalType = 'cabinet';
            editingCabinet = false;
            document.getElementById('addTitle').textContent = '新增櫃體';
            document.getElementById('addInput').value = '';
            document.getElementById('addInput').dataset.oldId = '';
            document.getElementById('cabinetType').classList.remove('hidden');
            document.getElementById('deleteAdd').classList.add('hidden');
            document.getElementById('dimensionsInputs').innerHTML = '';
            document.getElementById('addModal').classList.remove('hidden');
            document.getElementById('cabinetType').onchange = () => updateDimensionsInputs();
            updateDimensionsInputs();
        });

        document.getElementById('saveAdd').addEventListener('click', async () => {
            const name = document.getElementById('addInput').value.trim();
            if (!name) {
                alert('請輸入名稱！');
                return;
            }
            let id = name.toLowerCase().replace(/\s/g, '-');
            const oldId = document.getElementById('addInput').dataset.oldId || '';

            if (currentLocationId && !data.locations[currentLocationId]) {
                data.locations[currentLocationId] = { name: currentLocationId, areas: {} };
            }
            if (currentLocationId && currentAreaId && !data.locations[currentLocationId].areas[currentAreaId]) {
                data.locations[currentLocationId].areas[currentAreaId] = { name: currentAreaId, cabinets: {} };
            }

            if (addModalType === 'location') {
                if (oldId) {
                    data.locations[id] = { ...data.locations[oldId], name };
                    if (oldId !== id) delete data.locations[oldId];
                    currentLocationId = id;
                } else {
                    data.locations[id] = { name, areas: {} };
                    currentLocationId = id;
                }
                await saveData();
                renderLocationsPage();
            } else if (addModalType === 'area') {
                if (oldId) {
                    data.locations[currentLocationId].areas[id] = {
                        ...data.locations[currentLocationId].areas[oldId],
                        name
                    };
                    if (oldId !== id) delete data.locations[currentLocationId].areas[oldId];
                    currentAreaId = id;
                } else {
                    data.locations[currentLocationId].areas[id] = { name, cabinets: {} };
                    currentAreaId = id;
                }
                await saveData();
                renderAreasPage();
            } else if (addModalType === 'cabinet') {
                const type = document.getElementById('cabinetType').value;
                const inputElements = document.querySelectorAll('#dimensionsInputs input');
                let dimensions = {};

                if (type === 'L') {
                    dimensions = {
                        short: inputElements[0]?.value.trim() || '',
                        long: inputElements[1]?.value.trim() || ''
                    };
                    if (!validateDimension(dimensions.short) || !validateDimension(dimensions.long)) {
                        alert('L型櫃體規格格式錯誤，請輸入如 3x3 的格式！');
                        return;
                    }
                    const shortId = `${id}-short`;
                    const longId = `${id}-long`;
                    const shortName = `${name} 短`;
                    const longName = `${name} 長`;
                    const existingCells = editingCabinet && data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[editingCabinetId]?.cells_data || {};
                    data.locations[currentLocationId].areas[currentAreaId].cabinets[shortId] = {
                        name: shortName,
                        type,
                        dimensions: { size: dimensions.short },
                        cells_data: editingCabinet ? existingCells : {}
                    };
                    data.locations[currentLocationId].areas[currentAreaId].cabinets[longId] = {
                        name: longName,
                        type,
                        dimensions: { size: dimensions.long },
                        cells_data: {}
                    };
                    if (editingCabinet && editingCabinetId && editingCabinetId !== shortId && editingCabinetId !== longId) {
                        delete data.locations[currentLocationId].areas[currentAreaId].cabinets[editingCabinetId];
                    }
                } else if (type === 'U' || type === 'square') {
                    const sides = type === 'U' ? 3 : 4;
                    for (let i = 0; i < sides; i++) {
                        const sideDim = inputElements[i]?.value.trim() || '';
                        if (!validateDimension(sideDim)) {
                            alert(`面${i + 1}規格格式錯誤，請輸入如 3x3 的格式！`);
                            return;
                        }
                        const sideId = `${id}-side${i + 1}`;
                        const sideName = `${name} 面${i + 1}`;
                        const existingCells = (editingCabinet && i === 0) ? (data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[editingCabinetId]?.cells_data || {}) : {};
                        data.locations[currentLocationId].areas[currentAreaId].cabinets[sideId] = {
                            name: sideName,
                            type,
                            dimensions: { size: sideDim },
                            cells_data: existingCells
                        };
                    }
                    if (editingCabinet && editingCabinetId) {
                        delete data.locations[currentLocationId].areas[currentAreaId].cabinets[editingCabinetId];
                    }
                } else {
                    dimensions.size = inputElements[0]?.value.trim() || '';
                    if (!validateDimension(dimensions.size)) {
                        alert('櫃體規格格式錯誤，請輸入如 3x3 的格式！');
                        return;
                    }
                    const cabId = editingCabinet ? editingCabinetId : id;
                    const existingCells = data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[cabId]?.cells_data || {};
                    data.locations[currentLocationId].areas[currentAreaId].cabinets[cabId] = {
                        name,
                        type,
                        dimensions,
                        cells_data: existingCells
                    };
                }
                await saveData();
                renderCabinets();
            }
            document.getElementById('addModal').classList.add('hidden');
            document.getElementById('addInput').dataset.oldId = '';
            editingCabinet = false;
            editingCabinetId = null;
            addModalType = '';
        });

        document.getElementById('deleteAdd').addEventListener('click', async () => {
            const oldId = document.getElementById('addInput').dataset.oldId;
            if (addModalType === 'location' && oldId) {
                if (confirm('確定要刪除這個地點嗎？(包含所有子資料)')) {
                    delete data.locations[oldId];
                    await saveData();
                    renderLocationsPage();
                }
            } else if (addModalType === 'area' && oldId) {
                if (confirm('確定要刪除這個區域嗎？(包含所有子資料)')) {
                    delete data.locations[currentLocationId]?.areas[oldId];
                    await saveData();
                    renderAreasPage();
                }
            } else if (addModalType === 'cabinet' && editingCabinetId) {
                if (confirm('確定要刪除這個櫃體嗎？')) {
                    delete data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[editingCabinetId];
                    await saveData();
                    renderCabinets();
                }
            }
            document.getElementById('addModal').classList.add('hidden');
            document.getElementById('addInput').dataset.oldId = '';
            editingCabinet = false;
            editingCabinetId = null;
            addModalType = '';
        });

        document.getElementById('searchBtn').addEventListener('click', async () => {
            const query = document.getElementById('searchName').value.toLowerCase();
            const date = document.getElementById('searchDate').value;
            let results = [];
            Object.entries(data.locations).forEach(([locId, loc]) => {
                Object.entries(loc.areas || {}).forEach(([areaId, area]) => {
                    Object.entries(area.cabinets || {}).forEach(([cabId, cab]) => {
                        Object.entries(cab.cells_data || {}).forEach(([cellId, cell]) => {
                            cell.items?.forEach(item => {
                                if ((query && item.name.toLowerCase().includes(query)) || (date && item.expiryDate === date)) {
                                    results.push({ location: loc.name, area: area.name, cabinet: cab.name, cellId, item });
                                }
                            });
                        });
                    });
                });
            });
            alert(`搜尋結果：\n${results.map(r => `${r.location} > ${r.area} > ${r.cabinet} > ${r.cellId} > ${r.item.name}`).join('\n') || '無結果'}`);
        });

        function checkReminders() {
            const today = new Date();
            const reminders = [];
            Object.entries(data.locations).forEach(([locId, loc]) => {
                const areas = loc.areas || {};
                Object.entries(areas).forEach(([areaId, area]) => {
                    const cabinets = area.cabinets || {};
                    Object.entries(cabinets).forEach(([cabId, cab]) => {
                        const cells = cab.cells_data || {};
                        Object.entries(cells).forEach(([cellId, cell]) => {
                            const items = cell.items || [];
                            items.forEach(item => {
                                if (item.expiryDate && (new Date(item.expiryDate) - today) / (1000 * 60 * 60 * 24) < 30) {
                                    reminders.push({ location: loc.name, area: area.name, cabinet: cab.name, cellId, item: item.name });
                                }
                            });
                        });
                    });
                });
            });
            if (reminders.length > 0) {
                document.getElementById('reminderList').innerHTML = reminders.map(r => `
                    <p class="cursor-pointer" onclick="navigateToItem('${r.location}', '${r.area}', '${r.cabinet}', '${r.cellId}')">
                        ${r.location} > ${r.area} > ${r.cabinet} > ${r.cellId} > ${r.item}
                    </p>`).join('');
                document.getElementById('reminderModal').classList.remove('hidden');
            }
        }

        function isExpiringSoon(expiryDate) {
            if (!expiryDate) return false;
            const today = new Date();
            return (new Date(expiryDate) - today) / (1000 * 60 * 60 * 24) < 30;
        }

        function navigateToItem(locationName, areaName, cabinetName, cellId) {
            const locId = Object.keys(data.locations).find(id => data.locations[id].name === locationName);
            if (!locId) return;
            const areaId = Object.keys(data.locations[locId].areas || {}).find(id => data.locations[locId].areas[id].name === areaName);
            if (!areaId) return;
            const cabId = Object.keys(data.locations[locId].areas[areaId].cabinets || {}).find(id => data.locations[locId].areas[areaId].cabinets[id].name === cabinetName);
            if (!cabId) return;
            currentLocationId = locId;
            currentAreaId = areaId;
            currentCabinetId = cabId;
            renderAreasPage();
            setTimeout(() => {
                enterArea(areaId);
                setTimeout(() => {
                    enterCabinet(cabId);
                    setTimeout(() => openItemModal(cellId), 100);
                }, 100);
            }, 100);
        }

        document.getElementById('itemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const item = {
                name: document.getElementById('itemName').value.trim(),
                quantity: document.getElementById('itemQty').value || '',
                entryDate: document.getElementById('itemInDate').value || '',
                expiryDate: document.getElementById('itemExpDate').value || '',
                purchasePlace: document.getElementById('itemPlace').value || '',
                notes: document.getElementById('itemNote').value || '',
                image: ''
            };
            if (!item.name) {
                alert('物品名稱為必填！');
                return;
            }
            const imageInput = document.getElementById('itemImage');
            const cab = data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[currentCabinetId];
            if (!cab) {
                alert('櫃體資料缺失，請返回重新選擇');
                return;
            }
            if (!cab.cells_data) cab.cells_data = {};
            if (!cab.cells_data[currentCellId]) {
                cab.cells_data[currentCellId] = { items: [], merged: false, span: { row: 1, col: 1 }, text: '' };
            }
            const cell = cab.cells_data[currentCellId];
            const items = cell.items || [];

            const processItem = async (newImage) => {
                item.image = newImage || (editingItemIndex > -1 ? items[editingItemIndex]?.image || '' : '');
                if (editingItemIndex > -1) {
                    items[editingItemIndex] = item;
                } else {
                    items.push(item);
                }
                cell.text = items.map(i => i.name).join(', ');
                cell.items = items;
                await saveData();
                document.getElementById('itemForm').reset();
                document.getElementById('itemModal').classList.add('hidden');
                renderCells();
                checkReminders();
                editingItemIndex = -1;
            };

            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => processItem(e.target.result);
                reader.onerror = () => alert('圖片讀取失敗，請重試！');
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                await processItem('');
            }
        });

        // 物品列表事件委託
        document.getElementById('itemsList').addEventListener('click', (e) => {
            const target = e.target;
            const index = parseInt(target.dataset.index);
            if (target.classList.contains('edit-item')) {
                editItem(index);
            } else if (target.classList.contains('remove-image')) {
                removeImage(index);
            } else if (target.classList.contains('delete-item')) {
                deleteItem(index);
            } else if (target.classList.contains('item-image')) {
                previewImage(decodeURIComponent(target.dataset.image));
            } else if (target.classList.contains('move-up')) {
                moveItemUp(index);
            } else if (target.classList.contains('move-down')) {
                moveItemDown(index);
            }
        });

        // 排序事件委託
        document.getElementById('itemsTable').addEventListener('click', (e) => {
            const target = e.target.closest('th[data-sort]');
            if (target) {
                const field = target.dataset.sort;
                sortItems(field);
            }
        });

        function previewImage(imageSrc) {
            document.getElementById('previewImage').src = imageSrc;
            document.getElementById('imagePreviewModal').classList.remove('hidden');
        }

        document.getElementById('editGridBtn').addEventListener('click', async () => {
            editMode = !editMode;
            document.getElementById('editGridBtn').textContent = editMode ? '完成編輯 (合併選取格子)' : '編輯網格';
            if (!editMode && selectedCells.length > 0 && !selectedCells.some(id => data.locations[currentLocationId]?.areas[currentAreaId]?.cabinets[currentCabinetId]?.cells_data[id]?.merged)) {
                await mergeCells();
            }
            selectedCells = [];
            renderCells();
        });

        document.getElementById('undoMergeBtn').addEventListener('click', () => {
            undoMerge();
        });

        document.getElementById('splitCellBtn').addEventListener('click', () => {
            splitCell();
        });

        document.getElementById('closeImagePreview').addEventListener('click', () => {
            document.getElementById('imagePreviewModal').classList.add('hidden');
        });

        document.getElementById('cancelAdd').addEventListener('click', () => {
            document.getElementById('addModal').classList.add('hidden');
            document.getElementById('addInput').dataset.oldId = '';
            editingCabinet = false;
            editingCabinetId = null;
            addModalType = '';
        });

        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('itemModal').classList.add('hidden');
        });

        document.getElementById('closeReminder').addEventListener('click', () => {
            document.getElementById('reminderModal').classList.add('hidden');
        });

        document.getElementById('searchName').addEventListener('input', debounce(() => document.getElementById('searchBtn').click(), 300));

        document.getElementById('cabinetType').addEventListener('change', () => updateDimensionsInputs());

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        document.getElementById('exportBtn').addEventListener('click', async () => {
            const snapshot = await get(ref(db, '/cabinetData'));
            const exportData = snapshot.val() || data;
            if (Object.keys(exportData).length === 0) {
                alert('目前沒有資料可匯出！');
                return;
            }
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'cabinetAppData.json';
            link.click();
            URL.revokeObjectURL(url);
            alert('資料已匯出為 cabinetAppData.json 檔案，請妥善保存！');
        });

        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('importInput').value = '';
            document.getElementById('importInput').click();
        });

        document.getElementById('importInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (!file.name.endsWith('.json')) {
                alert('請選擇有效的 JSON 檔案！');
                return;
            }
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (!importedData.locations || typeof importedData.locations !== 'object') {
                        throw new Error('無效的資料結構');
                    }
                    Object.keys(importedData.locations).forEach(locId => {
                        if (!importedData.locations[locId].areas) {
                            importedData.locations[locId].areas = {};
                        }
                        if (locId === '家裡' && Object.keys(importedData.locations[locId].areas).length === 0) {
                            importedData.locations[locId].areas = defaultLocations[0].areas.reduce((areaAcc, areaName) => {
                                const areaId = areaName.toLowerCase().replace(/\s/g, '-');
                                areaAcc[areaId] = { name: areaName, cabinets: {} };
                                return areaAcc;
                            }, {});
                        }
                        Object.keys(importedData.locations[locId].areas).forEach(areaId => {
                            if (!importedData.locations[locId].areas[areaId].cabinets) {
                                importedData.locations[locId].areas[areaId].cabinets = {};
                            }
                        });
                    });
                    await set(ref(db, '/cabinetData'), importedData);
                    data = importedData;
                    renderLocationsPage();
                    checkReminders();
                    alert('資料已成功匯入並恢復！');
                } catch (error) {
                    alert('匯入失敗：無效的 JSON 檔案或資料結構錯誤。錯誤訊息：' + error.message);
                }
            };
            reader.readAsText(file);
        });

        // 事件委託綁定
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('backToLocations')) {
                currentLocationId = null;
                currentAreaId = null;
                currentCabinetId = null;
                renderLocationsPage();
            } else if (e.target.classList.contains('backToAreas')) {
                currentAreaId = null;
                currentCabinetId = null;
                renderAreasPage();
            } else if (e.target.classList.contains('backToCabinets')) {
                currentCabinetId = null;
                document.getElementById('cellsPage').classList.add('hidden');
                document.getElementById('cabinetsPage').classList.remove('hidden');
                renderCabinets();
            } else if (e.target.closest('.location-card')) {
                const locId = e.target.closest('.location-card').dataset.locId;
                if (locId) enterLocation(locId);
            } else if (e.target.closest('.edit-location')) {
                const locId = e.target.closest('.edit-location').dataset.locId;
                if (locId) editLocation(locId, e);
            } else if (e.target.closest('.area-card')) {
                const areaId = e.target.closest('.area-card').dataset.areaId;
                if (areaId) enterArea(areaId);
            } else if (e.target.closest('.edit-area')) {
                const areaId = e.target.closest('.edit-area').dataset.areaId;
                if (areaId) editArea(areaId, e);
            } else if (e.target.classList.contains('view-cabinet')) {
                const cabId = e.target.dataset.cabId;
                if (cabId) enterCabinet(cabId);
            } else if (e.target.classList.contains('edit-cabinet')) {
                const cabId = e.target.dataset.cabId;
                if (cabId) editCabinet(cabId, e);
            } else if (e.target.classList.contains('delete-cabinet')) {
                const cabId = e.target.dataset.cabId;
                if (cabId) deleteCabinet(cabId, e);
            }
        });

        // 初始化應用程式
        async function init() {
            await loadData();
            renderLocationsPage();
            checkReminders();
        }

        init();
    </script>
</body>
</html>
